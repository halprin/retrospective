files:
  "/opt/python/etc/daphne.conf":
    mode: "000755"
    owner: root
    group: root
    content: |
      [program:daphne]
      command=bash -c "source ../env && exec /opt/python/run/venv/bin/daphne -b 0.0.0.0 -p 81 backend.retrospective.asgi:application"
      numprocs=1
      process_name=%(program_name)s_%(process_num)02d
      directory=/opt/python/current/app
      autostart=true
      autorestart=unexpected
      startsecs=1
      startretries=3
      exitcodes=0,2
      killasgroup=true
  "/etc/httpd/conf.d/reverseproxy.conf":
    mode: "000755"
    owner: root
    group: root
    content: |
      <VirtualHost *:80>
        ProxyPass /api/ws/ ws://127.0.0.1:81/api/ws/
        ProxyPassReverse /api/ws/ ws://127.0.0.1:81/api/ws/

        ProxyPass / http://127.0.0.1:81/
        ProxyPassReverse / http://127.0.0.1:81/
      </VirtualHost>

      LogFormat "%h (%{X-Forwarded-For}i) %l %u %t \"%r\" %>s %b \"%{Referer}i\" \"%{User-Agent}i\"" combined

container_commands:
  00_remove_wsgi_from_apache_httpd:
    command: 'rm ../wsgi.conf'
  01_include_daphne_supervisord_conf:
    command: 'echo "[include]" >> /opt/python/etc/supervisord.conf && echo "files=daphne.conf" >> /opt/python/etc/supervisord.conf'
  02_update_daphne:
    command: 'sudo /usr/local/bin/supervisorctl -c /opt/python/etc/supervisord.conf update'
  03_reload_apache_httpd:
    command: 'sudo service httpd reload'

